name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  security-events: write
  actions: read

env:
  GOSEC_SEVERITY: medium
  GOSEC_CONFIDENCE: medium

jobs:
  gosec:
    name: GoSec Security Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Run GoSec Security Scanner
        uses: securego/gosec@v2.21.4
        with:
          # Full recursive scan - severity and confidence levels configurable via env vars
          args: '-fmt sarif -out gosec-results.sarif -severity ${{ env.GOSEC_SEVERITY }} -confidence ${{ env.GOSEC_CONFIDENCE }} ./...'

      - name: Upload GoSec SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      - name: Check GoSec results
        run: |
          # Fail the build if high or critical vulnerabilities are found
          # Using robust jq query to properly parse SARIF format
          if jq -e '.runs[].results[] | select(.level == "error")' gosec-results.sarif > /dev/null 2>&1; then
            echo "❌ High or critical security vulnerabilities found!"
            exit 1
          else
            echo "✅ No high or critical security vulnerabilities found"
          fi

  trivy-repo:
    name: Trivy Repository Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-repo-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0' # Don't fail on SARIF generation to ensure upload completes

      - name: Upload Trivy SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-repo-results.sarif'
          category: trivy-repo

      - name: Check Trivy results for critical vulnerabilities
        run: |
          # Fail the build if high or critical vulnerabilities are found
          # Using robust jq query to properly parse SARIF format
          if jq -e '.runs[].results[] | select(.level == "error" or .level == "warning")' trivy-repo-results.sarif > /dev/null 2>&1; then
            echo "❌ High or critical vulnerabilities found in repository scan!"
            exit 1
          else
            echo "✅ No high or critical vulnerabilities found"
          fi

  trivy-config:
    name: Trivy Config Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy configuration scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0' # Don't fail on SARIF generation to ensure upload completes

      - name: Upload Trivy config SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: trivy-config

      - name: Check Trivy config results for critical issues
        run: |
          # Fail the build if high or critical configuration issues are found
          # Using robust jq query to properly parse SARIF format
          if jq -e '.runs[].results[] | select(.level == "error" or .level == "warning")' trivy-config-results.sarif > /dev/null 2>&1; then
            echo "❌ High or critical configuration issues found!"
            exit 1
          else
            echo "✅ No high or critical configuration issues found"
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: |
          govulncheck -show verbose ./...

      - name: Check for vulnerabilities
        run: |
          OUTPUT=$(govulncheck ./... 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "Vulnerability"; then
            echo "❌ Vulnerabilities found in dependencies!"
            exit 1
          else
            echo "✅ No known vulnerabilities in dependencies"
          fi

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gosec, trivy-repo, trivy-config, govulncheck]
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GoSec | ${{ needs.gosec.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Repo | ${{ needs.trivy-repo.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Config | ${{ needs.trivy-config.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GovulnCheck | ${{ needs.govulncheck.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.gosec.result }}" != "success" ] || \
             [ "${{ needs.trivy-repo.result }}" != "success" ] || \
             [ "${{ needs.trivy-config.result }}" != "success" ] || \
             [ "${{ needs.govulncheck.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Some security checks failed. Please review the results above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All security checks passed successfully!**" >> $GITHUB_STEP_SUMMARY
          fi
